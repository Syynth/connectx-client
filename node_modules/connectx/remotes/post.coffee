req = require 'superagent'
{ApiUrl} = require 'connectx/constants'
{CurrentUserStore, PostStore} = require 'connectx/stores'
stub = require './stubHelpers'
_ = require 'lodash'
guid = require 'guid'

token = -> CurrentUserStore.getCurrentUser().token

module.exports =
  createPost: (post, cb) ->
    post.id = stub.getServerId()
    _.delay (-> cb stub.getRandomError(0.5), post), stub.getNetworkDelay()
    ###
    req.post "#{ApiUrl}/post"
      .type 'json'
      .set 'CONNECTX-AUTH', token()
      .attach 'file', new Blob([new Uint8Array(array)], {type: 'image/png'}), guid.create().value
      .send _.omit PostStore.trim(post), 'file' # removes client-side only properties
      .end (err, res) ->
        unless res.error
          cb null, res.body
        else
          cb res.error
    ###
  commentOn: (postId, comment, cb) ->
    comment.id = stub.getServerId()
    _.delay (-> cb stub.getRandomError(0.5), comment), stub.getNetworkDelay(100, 300)
