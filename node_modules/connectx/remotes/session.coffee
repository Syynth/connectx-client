NotificationActionCreators = require 'connectx/actions/notificationActionCreators'
req = require 'superagent'
{ApiUrl} = require 'connectx/config'

postLogin = (user, cb) ->
  req.post "#{ApiUrl}/login"
    .type 'form'
    .withCredentials()
    .send user
    .end (err, res) ->
      if err
        console.log err
        NotificationActionCreators.postNotification
          message: "Something went wrong during login. Please try again later"
          status: 'failure'
        return
      unless res.error
        res.body.id = res.body._id
        cb res.body
      else
        NotificationActionCreators.postNotification
          message: "Login failed: #{res.error.message}"
          detail: res.error.message
          status: 'failure'

postRegister = (user) ->
  req.post "#{ApiUrl}/register"
    .send user
    .end (err, res) ->
      if err
        console.log err
        NotificationActionCreators.postNotification
          message: "Something went wrong during registration. Please try again later"
          status: 'failure'
        return
      unless res.error
        NotificationActionCreators.postNotification
          message: 'Account successfully created. Please verify by checking your email'
      else
        console.log err
        NotificationActionCreators.postNotification
          message: "Registration failed: #{res.error.message}"
          status: 'failure'

module.exports =
  postLogin: postLogin
  postRegister: postRegister
