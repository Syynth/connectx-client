# @cjsx React.DOM

React = require 'react'
{PostActionCreators} = require 'connectx/actions'
{SwallowEvent} = require 'connectx/mixins'
Icon = require 'connectx/components/icon'

guid = require 'guid'

PostForm = module.exports = React.createClass
  getInitialState: -> loading: false, type: 'text', text: '', file: null
  mixins: [SwallowEvent]
  updateText: (e) ->
    @setState text: e.target.value
  postMessage: (e) ->
    e.preventDefault()
    if @state.text.trim() isnt '' or @state.file?
      PostActionCreators.createPost
        title: guid.create()
        text: @state.text
        author: @props.current
        owner: @props.entity
        createdAt: Date.now()
        file: @state.file
    @setState {text: '', file: null}
  readFile: (f) ->
    r = new FileReader()
    r.onloadend = => @setState file: r.result
    r.readAsDataURL f
  filePicked: (e) -> @readFile e.target.files?[0] if e.target.files?[0]?
  clickFile: (e) -> @refs.fileInput.getDOMNode().click()
  render: ->
    <div>
      <div className="comments_wrapper">
        <div className="c_header" />
        <div className="c_body">
          <div className="c_body_container">
            <form className="post-form" onSubmit={@swallowEvent}>
              <textarea className="comment" value={@state.text} onChange={@updateText} placeholder="Whats on your mind?" ref="postText" />
              <article className="post_bar_bottom">
                <div className="left_btn partition">
                  {
                    if @state.file
                      <figure className="postFigure">
                        <img src={@state.file} onClick={@clickFile} className="preview preview-file" />
                      </figure>
                  }
                  <input ref="fileInput" onChange={@filePicked} className="add_img hideItem input-file" id="photo" name="photo" type="file" />
                  <label onClick={@clickFile} className="add_img photo-btn" for="photo">
                    <Icon centerIcon fa-camera />
                  </label>
                  <div className="clearfix" />
                </div>
                <div className="partition right_btn">
                  <button className="submit_comment" onClick={@postMessage}>POST</button>
                  <div className="clearfix" />
                </div>
                <div className="clearfix" />
              </article>
            </form>
          </div>
        </div>
      </div>
    </div>
