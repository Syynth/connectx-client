{PostApi} = require 'connectx/remotes'
Dispatcher = require 'connectx/dispatcher'
{ActionType} = require 'connectx/config'
guid = require 'guid'
_ = require 'lodash'

formatEntity = (entity) ->
  delete entity.password
  delete entity.__v
  delete entity.salt
  entity.id ?= entity._id
  entity

formatPost = (post) ->
  post.id ?= post._id
  post.owner = formatEntity post.owner
  post.author = formatEntity post.author
  post

formatReplies = (posts) ->
  replies = []
  posts.map (p) ->
    formatPost p
      .replies.map (r) ->
        r.id = r._id
        r.postId = p.id ? p._id
        replies.push r
  replies

syncPostSuccess = (post, clientId) ->
  post.id ?= post._id
  Dispatcher.handleServerAction
    type: ActionType.PostSaved
    post: post
    clientId: clientId
    serverId: post.id
syncPostFailure = (post, clientId) ->
  post.id ?= post._id
  Dispatcher.handleServerAction
    type: ActionType.PostCreationFailed
    post: post
    clientId: clientId

syncCommentSuccess = (postId, clientId, comment) ->
  Dispatcher.handleServerAction
    type: ActionType.CommentSaved
    postId: postId
    clientId: clientId
    serverId: comment.id
    comment: comment
syncCommentFailure = (postId, comment) ->
  Dispatcher.handleServerAction
    type: ActionType.CommentFailed
    postId: postId
    comment: comment

module.exports =

  createPost: (post) ->
    clientId = guid.create().value
    Dispatcher.handleClientAction
      type: ActionType.CreatePost
      clientId: clientId
      posts: [post]
    PostApi.createPost post, (err, data) ->
      return syncPostFailure post, clientId if err
      syncPostSuccess data, clientId

  createComment: (postId, comment) ->
    clientId = guid.create().value
    Dispatcher.handleClientAction
      type: ActionType.CommentCreate
      postId: postId
      comments: [comment]
      clientId: clientId
    PostApi.commentOn postId, comment, (err, data) ->
      return syncCommentFailure postId, clientId, comment if err
      syncCommentSuccess postId, clientId, data

  removeComment: (comment) ->
    Dispatcher.handleClientAction
      type: ActionType.CommentDelete
      comment: comment

  retryPost: (post) ->
    clientId = post.postId
    Dispatcher.handleClientAction
      type: ActionType.PostResent
      clientId: clientId
      post: post
    PostApi.createPost post, (err, data) =>
      return syncPostFailure post, clientId if err
      syncPostSuccess data, clientId

  removePost: (post) ->
    Dispatcher.handleClientAction
      type: ActionType.RemovePost
      post: post
    PostApi.deletePost post.id, (err) -> console.log err

  queryPostsByEntity: (entity) ->
    PostApi.queryPosts entity.id, entity.type
      .then (posts) ->
        Dispatcher.handleServerAction
          type: ActionType.PostCollectionSync
          entity: entity
          posts: posts.map (p) -> formatPost p
          comments: formatReplies posts
        posts.map (post) ->
          Dispatcher.handleServerAction
            type: ActionType.EntityFetch
            entity: formatEntity post.owner
          Dispatcher.handlerServerAction
            type: ActionType.EntityFetch
            entity: formatEntity post.author
