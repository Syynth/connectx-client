{PostApi} = require 'connectx/remotes'
Dispatcher = require 'connectx/dispatcher'
{ActionType} = require 'connectx/constants'
guid = require 'guid'
_ = require 'lodash'

syncPostSuccess = (post, clientId) ->
  Dispatcher.handleServerAction
    type: ActionType.PostSaved
    post: post
    clientId: clientId
    serverId: post.id
syncPostFailure = (post, clientId) ->
  Dispatcher.handleServerAction
    type: ActionType.PostCreationFailed
    post: post
    clientId: clientId

module.exports =
  createPost: (post) -> # TODO: Add calls to remote to update other stuff!
    clientId = guid.create().value
    post.pending = true
    Dispatcher.handleClientAction
      type: ActionType.CreatePost
      clientId: clientId
      posts: [post]
    PostApi.createPost post, (err, data) =>
      return syncPostFailure post, clientId if err
      syncPostSuccess data, clientId
  removePost: (post) ->
    Dispatcher.handleClientAction
      type: ActionType.RemovePost
      post: post
  queryPostsByEntity: (entity) ->
    PostApi.queryPosts entity.id, entity.type
