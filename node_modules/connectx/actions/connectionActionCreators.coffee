NotificationActionCreators = require './notificationActionCreators'
Dispatcher = require 'connectx/dispatcher'

guid = require 'guid'

{ActionType} = require 'connectx/config'

{ConnectionApi} = require 'connectx/remotes'

module.exports =

  createConnection: (from, to) ->
    NotificationActionCreators.postNotification message: "Sending request from #{from.name} to #{to.name}"
    Dispatcher.handleClientAction
      type: ActionType.ConnectionSentClient
      from: from
      to: to
    ConnectionApi.createConnection from, to, {admin: false}
      .then ->
        Dispatcher.handleServerAction
          type: ActionType.ConnectionCreated
          from: from
          to: to
        EntityActionCreators.fetchEntity from.id, from.type
        EntityActionCreators.fetchEntity to.id, to.type

  deleteConnection: (from, to) ->
    NotificationActionCreators.postNotification message: "Removing connection between #{from.name} and #{to.name}"
    Dispatcher.handleClientAction
      type: ActionType.ConnectionDeletedClient
      from: from
      to: to
    ConnectionApi.deleteConnection from, to
      .then ->
        Dispatcher.handleServerAction
          type: ActionType.ConnectionDeleted
          from: from
          to: to

  searchIncomingConnectionsToByType: (entity, type) ->
    ConnectionApi.searchConnections(type, undefined, entity.type, entity.id, true)
      .then (results) ->
        Dispatcher.handleServerAction
          type: ActionType.ConnectionQuery
          entityType: type
          entities: results.map (entity) ->
            entity.type = type
            entity.id = entity._id
            return entity

  searchIncomingConnectionsTo: (entity) ->
    for type in ['user', 'group', 'event', 'course']
      @searchIncomingConnectionsToByType entity, type
