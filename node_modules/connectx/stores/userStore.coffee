_ = require 'lodash'
{EventEmitter} = require 'events'

{SourceType, ActionType} = require 'connectx/constants'
Dispatcher = require 'connectx/dispatcher'
Cache = require 'connectx/cache'

BaseStore = require './baseStore'

p = new Cache

recordUser = (action) ->
  id = action.user.id
  p.set id, action.user
  @commit()

removeAllUsers = (action) ->
  p.clear()
  @commit()

wipeCache = ->
  p = new Cache
  @write 'userCache', p.data

class UserStore extends BaseStore
  storeKey: 'USER_STORE'
  schema:
    id: String
    about_text: String
    email: String
    images: [String]
    name: String
    password: String
    salt: String
    token: String
    verificationId: String
  constructor: (dispatcher) ->
    super dispatcher
    p = new Cache @read 'userCache'
  commit: ->
    @emitChange()
    @write 'userCache', p.data
  getById: (id) -> p.query (user) -> user.id is id
  onStorageFull: -> removeAllPosts.call @
  handlers: [
    action: ActionType.UserLogin
    fn: recordUser
  ,
    action: ActionType.UserRead
    fn: recordUser
  ]

module.exports = new UserStore Dispatcher
