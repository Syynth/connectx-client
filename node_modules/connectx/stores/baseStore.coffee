
{EventEmitter} = require 'events'

ChangeEvent = 'change'

stores = {}

class BaseStore extends EventEmitter
  constructor: (@dispatcher) ->
    @dispatchToken = @dispatcher.register (payload) => @handleDispatch(payload)
  dependents: [] # Define this so it can be set optionally
  read: (key) ->if localStorage[@storeKey + key]? then JSON.parse localStorage[@storeKey + key] else null
  write: (key, value) -> localStorage[@storeKey + key] = JSON.stringify value
  emitChange: ->
    @emit ChangeEvent
  addChangeListener: (cb) ->
    @on ChangeEvent, cb
  removeChangeListener: (cb) ->
    @removeListener ChangeEvent, cb
  handleDispatch: (data) -> # TODO: Test this
    @dispatcher.waitFor @dependents.map (store) -> store.dispatchToken
    for handler in @handlers
      if handler.source is data.source and handler.type is data.action.type
        handler.fn.call @, data

module.exports = BaseStore
